function documentNamespace(namespace) {
    return {
        'require':function(what) {
            var split = what.split('.'),
                retval = window;
            for(var i = 0, len = split.length; i < len; ++i) {
                retval = retval[split[i]];
            }
            return retval;
        },
        'getExporter':function(name) {
            if(!name) {
                return function(export_name, to_export) { 
                    window[namespace][export_name] = to_export;
                };
            }
            window[namespace][name] = (window[namespace][name] === undefined) ? {} : window[namespace][name];
            return function(export_name, to_export) {
                window[namespace][name][export_name] = to_export;
            };
        }
    };
}

function commonjsNamespace(namespace, exp) {
    exp.require = function(what) {
        var regex = new RegExp("^" + namespace),
            retval,
            rest,
            parts;
        if(regex.test(what)) {
            return require(['./',what].join(''));
        } else {
            parts = what.split('.');
            rest = parts.slice(1);
            retval = require(parts[0]);
            for(var i = 0, len = rest.length; i < len; ++i) {
                retval = retval[rest[i]];
            }
            return retval;
        }
    };
    exp.getExporter = function(name) {
        var self = this;
        return function(export_name, to_export) {
            self[export_name] = to_export;
        };
    };
    return exp;
}

function get_global_object(namespace, exp) {
    if(exp) {
        return commonjsNamespace(namespace, exp);
    }

    if(window[namespace]) {
        return window[namespace];
    } else {
        window[namespace] = documentNamespace(namespace);
        return window[namespace];
    }
}
try {
    exports.get_global_object = get_global_object;
} catch(Error) {}

var get_global_object, exp=null;
try {
    exp = exports;
    get_global_object = require('./namespace').get_global_object;
} catch(Error) {}

(function (global) {
    var exporter = global.getExporter('fields');

    var PrepValue = function(value, clean_function) {
        this.value = value;
        this.clean_function = clean_function;
    };
    PrepValue.prototype.modify = function (callback) {
        return new PrepValue(callback(this.value), this.clean_function);
    };

    PrepValue.prototype.clean = function () {
        return this.clean_function(this.value);
    };

    var Field = function (kwargs) {
        if(kwargs) {
            this.nullable = kwargs.nullable;
            this.blank = kwargs.blank;
        } else {
            this.nullable = false;
            this.blank = false;
        }
    };

    Field.prototype.getJSValue = function(value) {
        return value;
    };

    var PositiveIntegerField = function(kwargs) {
        this.getPrepLookup = function(value, type) {
            return new PrepValue(value, function(value) {
                return parseInt(value, 10);
            });  
        };
        this.getJSValue = function(value) {
            return parseInt(value, 10);
        };

        Field.apply(this, [kwargs]);
    };
    PositiveIntegerField.prototype = new Field();
    PositiveIntegerField.prototype.constructor = PositiveIntegerField;

    var CharField = function (kwargs) {
        this.max_length = kwargs.max_length;
        this.getPrepLookup = function(value, type) {
            return new PrepValue(value, function(value) {
                return "'"+value.replace(/\\/g, "\\").replace(/'/g, "\\'")+"'";
            });
        };
        Field.apply(this, [kwargs]);
    };
    CharField.prototype = new Field();
    CharField.prototype.constructor = CharField;

    var TextField = function(kwargs) {
        this.getPrepLookup = function(value, type) {
            return new PrepValue(value, function(value) {
                return "'"+value.replace(/\\/g, '\\').replace(/'/g, "\\'")+"'";
            });
        };
    }; 
    TextField.prototype = new Field();
    TextField.prototype.constructor = TextField;

    var DateTimeField = function(kwargs) {
        this.getJSValue = function(value) {
            return new Date(Date.parse(value.split('.')[0]));
        };

        this.getPrepLookup = function(value, type) {
            return new PrepValue(value, function(value) {
                var pad = function(num) {
                    var ret = String(num).length == 1 ? '0'+String(num) : String(num);
                    return ret;
                };

                var datestr = [value.getFullYear(), pad(value.getMonth()), pad(value.getDate())].join('-');
                var timestr = [pad(value.getHours()), pad(value.getMinutes())].join(':');
                return "timestamp '"+datestr+" "+timestr+"'";
            });
        };
    };
    DateTimeField.prototype = new Field();
    DateTimeField.prototype.constructor = DateTimeField;

    exporter('Field', Field);
    exporter('PositiveIntegerField', PositiveIntegerField);
    exporter('DateTimeField', DateTimeField);
    exporter('CharField', CharField);
    exporter('TextField', TextField);
})(get_global_object('pieshop', exp));

var get_global_object, exp=null;
try { 
    exp = exports;
    get_global_object = require('./namespace').get_global_object;
} catch(Error) {}

(function (global) {
    var registry = {},
        values = {},
        exporter = global.getExporter('settings');

    var set_addon = function(name, target) {
        registry[name] = target;
    };

    var set_value = function(name, target) {
        values[name] = target;
    }; 

    var get_value = function(name) {
        return values[name];
    };

    var get_addon = function(name) {
        var target_string = registry[name],
            target_file_and_object = target_string.split(':'),
            target_file = global.require(target_file_and_object[0]),
            target_object_parts = target_file_and_object[1] !== undefined ? target_file_and_object[1].split(':') : [],
            result = target_file;
        for(var i = 0, len = target_object_parts.length; i < len; ++i) {
            result = result[target_object_parts[i]];
        }
        return result;
    };

    exporter('get_value', get_value);
    exporter('set_value', set_value); 
    exporter('get_addon', get_addon);
    exporter('set_addon', set_addon); 
})(get_global_object('pieshop', exp));

var get_global_object, exp=null;
try {
    exp = exports;
    get_global_object = require('./namespace').get_global_object;
} catch(Error) {}

(function (global) {
    var exporter = global.getExporter('backends');
    var CompiledQuery = function(backend, data, resource_uri) {
        this.backend = backend;
        this.data = data;
        this.resource_uri = resource_uri;
    };
    var dict_copy = function(x) { for(var i in x) { if (x.hasOwnProperty(i)) { this[i] = x[i]; } } };

    var TastyPieBackend = function () {};

    TastyPieBackend.prototype.build_resources = function(data, resource_type) {
        var objects = [];
        for(var i = 0, len = data.objects.length; i < len; ++i) {
            objects.push(new resource_type(data.objects[i]));
        }
        return objects;
    };

    TastyPieBackend.prototype.compile = function(query) {
        var data = {
            'format':'json',
        }; 
        if(query._limit) {
            data.limit = query._limit;
        }
        if(query._offset) {
            data.offset = query._offset;
        }
        if(query._order_by) {
            if(query._order_by instanceof Array) {
                data.sort_by = query._order_by[0];      // only sort by the primary value.
            } else {
                data.sort_by = query._order_by;
            }
        }
        var resource_uri = query.resource._meta.opts.resource_uri;

        dict_copy.call(data, query._filters);
        for(var i in query._filters) {
            if(query._filters.hasOwnProperty(i)) {
                if(i.split('__')[0] == 'pk') {
                    var item = query._filters[i],
                        resource_uri_split = resource_uri.split('/').slice(0,-1);
                    item = (item.length > 0 ? item : [item]).join(';');
                    resource_uri_split.push('set');
                    resource_uri_split.push(item);
                    resource_uri = resource_uri_split.join('/') + '/';
                    break;
                } else {
                    data[i] = query._filters[i];            
                }
            }
        }
        return new CompiledQuery(this, data, resource_uri);
    };

    exporter('CompiledQuery', CompiledQuery);
    exporter('TastyPieBackend', new TastyPieBackend());
})(get_global_object('pieshop', exp));

var get_global_object, exp=null;
try {
    exp = exports;
    get_global_object = require('./namespace').get_global_object;
} catch(Error) {}

(function (global) {
    var exporter = global.getExporter('transports');
    var jQueryAjaxTransport = function () {};
    jQueryAjaxTransport.prototype.perform = function(method, resource, compiled_query, callback) {
        var backends = global.require('pieshop.backends'),
            CompiledQuery = backends.CompiledQuery;
        if(!(compiled_query instanceof CompiledQuery)) {
            throw new Error("Transport.perform takes three arguments (Resource, CompiledQuery, callback)");
        }
        var data = compiled_query.data,
            backend = compiled_query.backend;
        jQuery.ajax({
            'url':compiled_query.resource_uri,
            'data':data,
            'type':method,
            'traditional':true,
            'dataType':'json',
            'success':function(incoming_data) {
                var resources = backend.build_resources(incoming_data, resource);
                callback(resources);
            }
        });
    };

    var nodeJsHttpClientTransport = function () {};
    nodeJsHttpClientTransport.prototype.perform = function(method, resource, compiled_query, callback) {
        var settings = global.require('pieshop.settings'),
            http = require('http'),
            querystring = require('querystring'),
            hostname = resource.prototype.hostname,
            hostport = resource.prototype.port ? resource.prototype.port : 80,
            client = http.createClient(hostport, hostname),
            data = querystring.stringify(compiled_query.data),
            uri = [compiled_query.resource_uri, data].join('?'),
            request = client.request(method, uri, {
                'host':hostname,
            });
        request.end();
        request.addListener('response', function (response) {
            response.setEncoding('utf8');
            response.addListener('data', function(chunk) {
                var resources = compiled_query.backend.build_resources(JSON.parse(chunk), resource);
                callback(resources);
            });
        }); 
    };

    exporter('jQueryAjaxTransport', new jQueryAjaxTransport());
    exporter('nodeJsHttpClientTransport', new nodeJsHttpClientTransport());
})(get_global_object('pieshop', exp));


var get_global_object, exp=null;
try {
    exp = exports;
    get_global_object = require('./namespace').get_global_object;
} catch(Error) {}

(function (global) {
    var exporter = global.getExporter(),
        settings = global.require('pieshop.settings');

    var dict_copy = function(params, filter) {
        var accept = filter ? filter : function(){return true;};

        for(var i in params) {
            if(params.hasOwnProperty(i) && accept(i)) {
                this[i] = params[i];
            }
        }
    };

    var Manager = function(model) {
        this.model = model;
    };
    Manager.prototype.all = function(callback) {
        this.getQuery().all(callback);
    };

    Manager.prototype.filter = function(kwargs) {
        return this.getQuery().filter(kwargs);
    };

    Manager.prototype.getQuery = function() {
        var query = this.getQuery(),
            opts = this.model._meta;
        if(opts.order_by) {
            query = query.copy({'_order_by':opts.ordering});
        }
        return query;
    };

    var ResourceMeta = function(fields, opts) {
        this.fields = fields;
        this.ordering = opts.ordering;
        this.opts = opts;
    };

    ResourceMeta.prototype.get_field_by_name = function(name) {
        return this.fields[name];
    };

    var resource_factory = function(opts) {
        var fields = global.require('pieshop.fields');
        var ResourceProto = {},
            Resource = function (data) {
                for(var field_name in data) if (data.hasOwnProperty(field_name)) {
                    var field = this._meta.get_field_by_name(field_name);
                    if(field) {
                        this[field_name] = field.getJSValue(data[field_name]);
                    } else {
                        this[field_name] = data[field_name];
                    }
                }
            };

        var model_fields = {},
            metaclass_opts = {};

        var build_model_fields = function(attribute) {
            if(opts[attribute] instanceof fields.Field) {
                model_fields[attribute] = opts[attribute];
                return false; 
            } else if (attribute === 'Meta') {
                metaclass_opts = metaclass_opts;
                return false;
            }
            return true;
        };

        dict_copy.call(ResourceProto, opts, build_model_fields);
        ResourceProto._meta = new ResourceMeta(model_fields, metaclass_opts);

        Resource._default_manager = new Manager(Resource);
        if(!Resource.objects) {
            Resource.objects = Resource._default_manager;
        }

        Resource.prototype = ResourceProto;
        return Resource;
    };

    var Query = function(Resource) {
        this.resource = Resource;
        this.method = 'GET';
        this.transport = arguments.length > 1 ? arguments[1] : settings.get_addon('transport');
        this.backend = arguments.length > 2 ? arguments[2] : settings.get_addon('backend');
    };

    Query.prototype = {
        'copy': function(params) {
            var new_query = new Query(this.resource);
            dict_copy.call(new_query, this);
            dict_copy.call(new_query, params);
            return new_query;
        },
        'order_by': function(ordering) {
            var copy = this.copy({'_order_by':ordering});
            return copy;
        },
        'limit': function(limit) {
            var copy = this.copy({'_limit': limit});
            return copy;
        },
        'offset': function(offset) {
            var copy = this.copy({'_offset': offset});
            return copy;
        },
        'filter': function(params) {
            var new_params = (this._filters) ? this._filters : {};
            dict_copy.call(new_params, params);
            return this.copy({'_filters':new_params});
        },
        'slice': function() {
            if(arguments.length > 0) {
                if(arguments.length === 1) {
                    return this.limit(parseInt(arguments[0], 10));
                }
                return this.offset(parseInt(arguments[0], 10)).limit(parseInt(arguments[1], 10));
            }
            return this.copy();
        },
        // commenting this out until tests are written
        'delete': function(callback) {
            var query = this.copy({'method': 'DELETE'}),
                backend = this.resource.backend === undefined ? this.backend : this.resource.backend,
                transport = this.resource.transport === undefined ? this.transport : this.resource.transport,
                compiled_query = backend.compile(query);
            transport.perform(query.method, query.resource, compiled_query, callback);
        },
        'create': function(kwargs, callback) {
            var query = this.copy({'method': 'PUT', 'values':kwargs}),
                backend = this.resource.backend === undefined ? this.backend : this.resource.backend,
                transport = this.resource.transport === undefined ? this.transport : this.resource.transport,
                compiled_query = backend.compile(query);
            transport.perform(query.method, query.resource, compiled_query, callback);
        },
        'update': function(kwargs, callback) {
            var query = this.copy({'method': 'POST', 'values':kwargs}),
                backend = this.resource.backend === undefined ? this.backend : this.resource.backend,
                transport = this.resource.transport === undefined ? this.transport : this.resource.transport,
                compiled_query = backend.compile(query);
            transport.perform(query.method, query.resource, compiled_query, callback);
        },
        'all': function(callback) {
            var query = this.copy({'method': 'GET'}),
                backend = this.resource.backend === undefined ? this.backend : this.resource.backend,
                transport = this.resource.transport === undefined ? this.transport : this.resource.transport,
                compiled_query = backend.compile(query);
            transport.perform(query.method, query.resource, compiled_query, callback);
        },
        'each': function(callback) {
            this.all(function(objects) {
                for (var i = 0, len = objects.length; i < len; ++i) {
                    callback.apply(objects[i], [objects[i]]);
                }
            });
        }
    };

    exporter('Query', Query);
    exporter('resource', resource_factory);
    exporter('query', function (Resource) { return new Query(Resource); });
})(get_global_object('pieshop', exp));
pieshop.settings.set_addon('backend', 'pieshop.backends:TastyPieBackend');
pieshop.settings.set_addon('transport', 'pieshop.transports:jQueryAjaxTransport');
